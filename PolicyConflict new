    <!-- Full DML for Policies Table (Single Table - Plans + Policies) -->
    <changeSet id="010-wizard-data" author="you">

        <!-- 1. SuperUser created Plans (Templates) - Minimal fields + premiumAmount -->
        <insert tableName="policies">
            <column name="user_id" value="1"/>
            <column name="plan_name" value="Family Life Cover"/>
            <column name="plan_type" value="Life Insurance"/>
            <column name="coverage_limit" value="1500000"/>
            <column name="premium_amount" value="12500"/>   <!-- Added premiumAmount -->
            <column name="is_template" valueBoolean="true"/>
        </insert>

        <insert tableName="policies">
            <column name="user_id" value="1"/>
            <column name="plan_name" value="Health Protect"/>
            <column name="plan_type" value="Health Insurance"/>
            <column name="coverage_limit" value="800000"/>
            <column name="premium_amount" value="15000"/>   <!-- Added premiumAmount -->
            <column name="is_template" valueBoolean="true"/>
        </insert>

        <insert tableName="policies">
            <column name="user_id" value="1"/>
            <column name="plan_name" value="Auto Safe Plus"/>
            <column name="plan_type" value="Motor Insurance"/>
            <column name="coverage_limit" value="1200000"/>
            <column name="premium_amount" value="18000"/>   <!-- Added premiumAmount -->
            <column name="is_template" valueBoolean="true"/>
        </insert>

        <!-- 2. User-issued Policies (Full 4-step wizard) - Select plan_id and fill wizard -->
        <insert tableName="policies">
            <column name="policy_id" value="1"/>  <!-- Same ID as plan -->
            <column name="user_id" value="3"/>
            <column name="holder_name" value="John Doe"/>
            <column name="holder_dob" value="1980-05-15"/>
            <column name="holder_address" value="123 Main St, Bangalore"/>
            <column name="income_source" value="Salary"/>
            <column name="total_income" value="100000"/>
            <column name="plan_name" value="Family Life Cover"/>
            <column name="plan_type" value="Life Insurance"/>
            <column name="coverage_limit" value="1500000"/>
            <column name="tenure_years" value="30"/>
            <column name="premium_frequency" value="quarterly"/>
            <column name="insured_amount" value="1000000"/>
            <column name="issuance_date" value="2026-02-10"/>
            <column name="maturity_date" value="2056-02-10"/>
            <column name="premium_amount" value="12500"/>
            <column name="maturity_amount" value="1500000"/>
            <column name="nominees_json" value='[{"name":"Jane Doe","contactNumber":"1234567890","dob":"2000-01-01","relationship":"Child","percentageStake":100}]'/>
            <column name="is_template" valueBoolean="false"/>
        </insert>

        <!-- Additional User-Issued Policy (Entry 4) -->
        <insert tableName="policies">
            <column name="policy_id" value="2"/>  <!-- Same ID as plan -->
            <column name="user_id" value="3"/>
            <column name="holder_name" value="Rahul Sharma"/>
            <column name="holder_dob" value="1992-07-15"/>
            <column name="holder_address" value="789 Park Avenue, Mumbai"/>
            <column name="income_source" value="IT Job"/>
            <column name="total_income" value="180000"/>
            <column name="plan_name" value="Health Protect"/>
            <column name="plan_type" value="Health Insurance"/>
            <column name="coverage_limit" value="800000"/>
            <column name="tenure_years" value="5"/>
            <column name="premium_frequency" value="monthly"/>
            <column name="insured_amount" value="500000"/>
            <column name="issuance_date" value="2026-03-01"/>
            <column name="maturity_date" value="2031-03-01"/>
            <column name="premium_amount" value="15000"/>
            <column name="maturity_amount" value="750000"/>
            <column name="nominees_json" value='[{"name":"Priya Sharma","contactNumber":"9876543210","dob":"2015-06-20","relationship":"Child","percentageStake":100}]'/>
            <column name="is_template" valueBoolean="false"/>
        </insert>

        <!-- Additional User-Issued Policy (Entry 5) -->
        <insert tableName="policies">
            <column name="policy_id" value="3"/>  <!-- Same ID as plan -->
            <column name="user_id" value="3"/>
            <column name="holder_name" value="Sneha Patel"/>
            <column name="holder_dob" value="1988-11-12"/>
            <column name="holder_address" value="45 MG Road, Ahmedabad"/>
            <column name="income_source" value="Business"/>
            <column name="total_income" value="220000"/>
            <column name="plan_name" value="Auto Safe Plus"/>
            <column name="plan_type" value="Motor Insurance"/>
            <column name="coverage_limit" value="1200000"/>
            <column name="tenure_years" value="5"/>
            <column name="premium_frequency" value="half-yearly"/>
            <column name="insured_amount" value="800000"/>
            <column name="issuance_date" value="2026-04-01"/>
            <column name="maturity_date" value="2031-04-01"/>
            <column name="premium_amount" value="18000"/>
            <column name="maturity_amount" value="950000"/>
            <column name="nominees_json" value='[{"name":"Aarav Patel","contactNumber":"5551234567","dob":"2018-03-15","relationship":"Child","percentageStake":100}]'/>
            <column name="is_template" valueBoolean="false"/>
        </insert>

    </changeSet>

-----------

    <!-- Policies Table - Single table for both SuperUser plans and User-issued policies -->
    <changeSet id="002-policies" author="you">
        <createTable tableName="policies">
            <column name="policy_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            
            <!-- SuperUser Plan Template Fields -->
            <column name="plan_name" type="VARCHAR(100)"/>
            <column name="plan_type" type="VARCHAR(50)"/>
            <column name="coverage_limit" type="DECIMAL(15,2)"/>
            <column name="is_template" type="BOOLEAN" defaultValueBoolean="false"/>
            
            <!-- User-filled 4-step wizard fields -->
            <column name="holder_name" type="VARCHAR(100)"/>
            <column name="holder_dob" type="DATE"/>
            <column name="holder_address" type="VARCHAR(255)"/>
            <column name="income_source" type="VARCHAR(100)"/>
            <column name="total_income" type="DECIMAL(15,2)"/>
            <column name="tenure_years" type="INT"/>
            <column name="premium_frequency" type="VARCHAR(20)"/>
            <column name="insured_amount" type="DECIMAL(15,2)"/>
            <column name="issuance_date" type="DATE"/>
            <column name="maturity_date" type="DATE"/>
            <column name="premium_amount" type="DECIMAL(15,2)"/>
            <column name="maturity_amount" type="DECIMAL(15,2)"/>
            
            <!-- Nominees merged as JSON string -->
            <column name="nominees_json" type="TEXT"/>
        </createTable>
    </changeSet>

----------
package com.example.policy.dto;

import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;

@Data
public class PolicyRequest {

    private Long userId;

    // SuperUser creates template with these fields
    private String planName;
    private String planType;
    private BigDecimal coverageLimit;
    private BigDecimal premiumAmount;     // ← Added for SuperUser creation
    private boolean isTemplate = false;

    // User selects plan and fills 4-step wizard
    private Long planId;                  // User selects this plan (same ID)

    // Step a: Personal Details
    private String holderName;
    private LocalDate holderDob;
    private String holderAddress;

    // Step b: Income Details
    private String incomeSource;
    private BigDecimal totalIncome;

    // Step c: Nominee Details (multiple allowed)
    private List<NomineeDetails> nominees;

    // Step d: Policy Details (user can override)
    private Integer tenureYears;
    private String premiumFrequency;
    private BigDecimal insuredAmount;
    private LocalDate issuanceDate;

    @Data
    public static class NomineeDetails {
        private String name;
        private String contactNumber;
        private LocalDate dob;
        private String relationship;
        private Integer percentageStake;
    }
}

----------

package com.example.policy.service;

import com.example.policy.dto.PolicyRequest;
import com.example.policy.entity.Policy;
import com.example.policy.entity.User;
import com.example.policy.repository.PolicyRepository;
import com.example.policy.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Service
public class PolicyService {

    @Autowired
    private PolicyRepository policyRepository;

    @Autowired
    private UserRepository userRepository;

    public Policy issuePolicy(PolicyRequest req) {

        Optional<User> optUser = userRepository.findById(req.getUserId());
        if (optUser.isEmpty()) {
            throw new RuntimeException("User not found");
        }

        User user = optUser.get();

        Policy policy = new Policy();
        policy.setUser(user);

        // SuperUser creating template (minimal fields)
        if (req.isTemplate()) {
            policy.setPlanName(req.getPlanName());
            policy.setPlanType(req.getPlanType());
            policy.setCoverageLimit(req.getCoverageLimit());
            policy.setPremiumAmount(req.getPremiumAmount());   // ← Added for SuperUser
            policy.setIsTemplate(true);
        } 
        // User issuing policy (selects plan + fills 4-step wizard)
        else {
            policy.setId(req.getPlanId());   // Same ID as plan
            policy.setPlanName(req.getPlanName());
            policy.setPlanType(req.getPlanType());
            policy.setCoverageLimit(req.getCoverageLimit());
            policy.setPremiumAmount(req.getPremiumAmount());

            // Step a: Personal Details
            policy.setHolderName(req.getHolderName());
            policy.setHolderDob(req.getHolderDob());
            policy.setHolderAddress(req.getHolderAddress());

            // Step b: Income Details
            policy.setIncomeSource(req.getIncomeSource());
            policy.setTotalIncome(req.getTotalIncome());

            // Step d: Policy Details
            policy.setTenureYears(req.getTenureYears());
            policy.setPremiumFrequency(req.getPremiumFrequency());
            policy.setInsuredAmount(req.getInsuredAmount());
            policy.setIssuanceDate(req.getIssuanceDate());

            policy.setIsTemplate(false);
        }

        // Auto-calculations (common for both)
        if (policy.getIssuanceDate() != null && policy.getTenureYears() != null) {
            policy.setMaturityDate(policy.getIssuanceDate().plusYears(policy.getTenureYears()));
        }

        if (policy.getInsuredAmount() != null && policy.getPremiumFrequency() != null) {
            BigDecimal base = policy.getInsuredAmount().multiply(new BigDecimal("0.05"));
            switch (policy.getPremiumFrequency().toLowerCase()) {
                case "monthly" -> policy.setPremiumAmount(base.divide(new BigDecimal("12"), 2, RoundingMode.HALF_UP));
                case "quarterly" -> policy.setPremiumAmount(base.divide(new BigDecimal("4"), 2, RoundingMode.HALF_UP));
                case "half-yearly" -> policy.setPremiumAmount(base.divide(new BigDecimal("2"), 2, RoundingMode.HALF_UP));
                default -> policy.setPremiumAmount(base);
            }
        }

        if (policy.getInsuredAmount() != null && policy.getTenureYears() != null) {
            BigDecimal mat = policy.getInsuredAmount()
                    .multiply(BigDecimal.valueOf(1.5))
                    .multiply(BigDecimal.valueOf(policy.getTenureYears() / 10.0));
            policy.setMaturityAmount(mat);
        }

        // Nominees as JSON
        List<PolicyRequest.NomineeDetails> nominees = req.getNominees();
        if (nominees != null && !nominees.isEmpty()) {
            try {
                policy.setNomineesJson(new ObjectMapper().writeValueAsString(nominees));
            } catch (Exception e) {
                throw new RuntimeException("Failed to process nominees");
            }
        } else {
            policy.setNomineesJson("[]");
        }

        return policyRepository.save(policy);
    }

    public List<Policy> getAllPolicies() {
        return policyRepository.findAll();
    }
}


-==-=-=-=-=-

public Policy issuePolicy(PolicyRequest req) {
    Optional<User> optUser = userRepository.findById(req.getUserId());
    if (optUser.isEmpty()) {
        throw new RuntimeException("User not found");
    }

    User user = optUser.get();

    Policy policy = new Policy();
    policy.setUser(user);

    // SuperUser creating template
    if (req.isTemplate()) {
        policy.setPlanName(req.getPlanName());
        policy.setPlanType(req.getPlanType());
        policy.setCoverageLimit(req.getCoverageLimit());
        policy.setPremiumAmount(req.getPremiumAmount());
        policy.setIsTemplate(true);   // ← Fixed
    } 
    // User issuing policy (selects plan)
    else {
        policy.setId(req.getPlanId());  // planId = policyId
        policy.setPlanName(req.getPlanName());
        policy.setPlanType(req.getPlanType());
        policy.setCoverageLimit(req.getCoverageLimit());
        policy.setPremiumAmount(req.getPremiumAmount());
        policy.setIsTemplate(false);   // ← Fixed

        // User 4-step wizard fields
        policy.setHolderName(req.getHolderName());
        policy.setHolderDob(req.getHolderDob());
        policy.setHolderAddress(req.getHolderAddress());
        policy.setIncomeSource(req.getIncomeSource());
        policy.setTotalIncome(req.getTotalIncome());
        policy.setTenureYears(req.getTenureYears());
        policy.setPremiumFrequency(req.getPremiumFrequency());
        policy.setInsuredAmount(req.getInsuredAmount());
        policy.setIssuanceDate(req.getIssuanceDate());
    }

    // Auto-calculations
    if (policy.getIssuanceDate() != null && policy.getTenureYears() != null) {
        policy.setMaturityDate(policy.getIssuanceDate().plusYears(policy.getTenureYears()));
    }

    if (policy.getInsuredAmount() != null && policy.getPremiumFrequency() != null) {
        BigDecimal base = policy.getInsuredAmount().multiply(new BigDecimal("0.05"));
        switch (policy.getPremiumFrequency().toLowerCase()) {
            case "monthly" -> policy.setPremiumAmount(base.divide(new BigDecimal("12"), 2, RoundingMode.HALF_UP));
            case "quarterly" -> policy.setPremiumAmount(base.divide(new BigDecimal("4"), 2, RoundingMode.HALF_UP));
            case "half-yearly" -> policy.setPremiumAmount(base.divide(new BigDecimal("2"), 2, RoundingMode.HALF_UP));
            default -> policy.setPremiumAmount(base);
        }
    }

    if (policy.getInsuredAmount() != null && policy.getTenureYears() != null) {
        BigDecimal mat = policy.getInsuredAmount()
                .multiply(BigDecimal.valueOf(1.5))
                .multiply(BigDecimal.valueOf(policy.getTenureYears() / 10.0));
        policy.setMaturityAmount(mat);
    }

    // Nominees as JSON
    List<PolicyRequest.NomineeDetails> nominees = req.getNominees();
    if (nominees != null && !nominees.isEmpty()) {
        try {
            policy.setNomineesJson(new ObjectMapper().writeValueAsString(nominees));
        } catch (Exception e) {
            throw new RuntimeException("Failed to process nominees");
        }
    } else {
        policy.setNomineesJson("[]");
    }

    return policyRepository.save(policy);
}
--

<!-- Policies Table - Single table for both templates and issued policies -->
<changeSet id="002-policies" author="you">
    <createTable tableName="policies">
        <column name="policy_id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="user_id" type="BIGINT">
            <constraints nullable="false"/>
        </column>
        <column name="plan_name" type="VARCHAR(100)"/>
        <column name="plan_type" type="VARCHAR(50)"/>
        <column name="coverage_limit" type="DECIMAL(15,2)"/>
        <column name="tenure_years" type="INT"/>
        <column name="premium_frequency" type="VARCHAR(20)"/>
        <column name="insured_amount" type="DECIMAL(15,2)"/>
        <column name="issuance_date" type="DATE"/>
        <column name="maturity_date" type="DATE"/>
        <column name="premium_amount" type="DECIMAL(15,2)"/>
        <column name="maturity_amount" type="DECIMAL(15,2)"/>
        <column name="holder_name" type="VARCHAR(100)"/>
        <column name="holder_dob" type="DATE"/>
        <column name="holder_address" type="VARCHAR(255)"/>
        <column name="income_source" type="VARCHAR(100)"/>
        <column name="total_income" type="DECIMAL(15,2)"/>
        <column name="nominees_json" type="TEXT"/>
        <column name="is_template" type="BOOLEAN" defaultValueBoolean="false"/>
    </createTable>
</changeSet>

=---------

    <!-- Full DML for Policies Table (Single Table) -->
    <changeSet id="010-wizard-data" author="you">

        <!-- SuperUser created Plans (Templates) -->
        <insert tableName="policies">
            <column name="user_id" value="1"/>
            <column name="plan_name" value="Family Life Cover"/>
            <column name="plan_type" value="Life Insurance"/>
            <column name="coverage_limit" value="1500000"/>
            <column name="premium_amount" value="12500"/>
            <column name="is_template" valueBoolean="true"/>
        </insert>

        <insert tableName="policies">
            <column name="user_id" value="1"/>
            <column name="plan_name" value="Health Protect"/>
            <column name="plan_type" value="Health Insurance"/>
            <column name="coverage_limit" value="800000"/>
            <column name="premium_amount" value="15000"/>
            <column name="is_template" valueBoolean="true"/>
        </insert>

        <insert tableName="policies">
            <column name="user_id" value="1"/>
            <column name="plan_name" value="Auto Safe Plus"/>
            <column name="plan_type" value="Motor Insurance"/>
            <column name="coverage_limit" value="1200000"/>
            <column name="premium_amount" value="18000"/>
            <column name="is_template" valueBoolean="true"/>
        </insert>

        <!-- User-issued Policies (Full 4-step wizard) -->
        <insert tableName="policies">
            <column name="policy_id" value="1"/>  <!-- Same ID as plan -->
            <column name="user_id" value="3"/>
            <column name="holder_name" value="John Doe"/>
            <column name="holder_dob" value="1980-05-15"/>
            <column name="holder_address" value="123 Main St"/>
            <column name="income_source" value="Salary"/>
            <column name="total_income" value="100000"/>
            <column name="plan_name" value="Family Life Cover"/>
            <column name="plan_type" value="Life Insurance"/>
            <column name="coverage_limit" value="1500000"/>
            <column name="tenure_years" value="30"/>
            <column name="premium_frequency" value="quarterly"/>
            <column name="insured_amount" value="1000000"/>
            <column name="issuance_date" value="2026-02-10"/>
            <column name="maturity_date" value="2056-02-10"/>
            <column name="premium_amount" value="12500"/>
            <column name="maturity_amount" value="1500000"/>
            <column name="nominees_json" value='[{"name":"Jane Doe","contactNumber":"1234567890","dob":"2000-01-01","relationship":"Child","percentageStake":100}]'/>
            <column name="is_template" valueBoolean="false"/>
        </insert>

        <!-- Additional User-Issued Policy -->
        <insert tableName="policies">
            <column name="policy_id" value="2"/>  <!-- Same ID as plan -->
            <column name="user_id" value="3"/>
            <column name="holder_name" value="Rahul Sharma"/>
            <column name="holder_dob" value="1992-07-15"/>
            <column name="holder_address" value="789 Park Avenue, Mumbai"/>
            <column name="income_source" value="IT Job"/>
            <column name="total_income" value="180000"/>
            <column name="plan_name" value="Health Protect"/>
            <column name="plan_type" value="Health Insurance"/>
            <column name="coverage_limit" value="800000"/>
            <column name="tenure_years" value="5"/>
            <column name="premium_frequency" value="monthly"/>
            <column name="insured_amount" value="500000"/>
            <column name="issuance_date" value="2026-03-01"/>
            <column name="maturity_date" value="2031-03-01"/>
            <column name="premium_amount" value="15000"/>
            <column name="maturity_amount" value="750000"/>
            <column name="nominees_json" value='[{"name":"Priya Sharma","contactNumber":"9876543210","dob":"2015-06-20","relationship":"Child","percentageStake":100}]'/>
            <column name="is_template" valueBoolean="false"/>
        </insert>

    </changeSet>

-=-=-=-=-=-=-=-=-=========
<changeSet id="011-plans-data" author="you">
    <!-- Plan 1: Life Insurance -->
    <insert tableName="plans">
        <column name="plan_name" value="Life Secure Plus"/>
        <column name="plan_type" value="Life Insurance"/>
        <column name="premium_amount" value="20000"/>
        <column name="coverage_limit" value="1500000"/>
    </insert>

    <!-- Plan 2: Health Insurance -->
    <insert tableName="plans">
        <column name="plan_name" value="Health Protect"/>
        <column name="plan_type" value="Health Insurance"/>
        <column name="premium_amount" value="15000"/>
        <column name="coverage_limit" value="500000"/>
    </insert>

    <!-- Plan 3: Property Insurance -->
    <insert tableName="plans">
        <column name="plan_name" value="Property Guard"/>
        <column name="plan_type" value="Property Insurance"/>
        <column name="premium_amount" value="18000"/>
        <column name="coverage_limit" value="1000000"/>
    </insert>

    <!-- Plan 4: Motor Insurance -->
    <insert tableName="plans">
        <column name="plan_name" value="Motor Safe"/>
        <column name="plan_type" value="Motor Insurance"/>
        <column name="premium_amount" value="12000"/>
        <column name="coverage_limit" value="750000"/>
    </insert>

    <!-- Plan 5: Life Insurance (additional) -->
    <insert tableName="plans">
        <column name="plan_name" value="Family Life Cover"/>
        <column name="plan_type" value="Life Insurance"/>
        <column name="premium_amount" value="25000"/>
        <column name="coverage_limit" value="2000000"/>
    </insert>
</changeSet>
==================================================================


// PolicyController.java (No changes from your original – it's already good. Comment: Added comments for clarity)
package com.example.policy.controller;

import com.example.policy.dto.PolicyView;
import com.example.policy.entity.Policy;
import com.example.policy.service.PolicyService;
import com.example.policy.dto.PolicyRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import com.example.policy.repository.PolicyRepository;

import java.util.List;

@RestController
@RequestMapping("/api/policies")
public class PolicyController {

    @Autowired
    private PolicyService policyService;

    @Autowired
    private PolicyRepository policyRepository;

    @PostMapping("/create")
    public Policy createPolicy(@RequestBody PolicyRequest req) {
        return policyService.issuePolicy(req);
    }

    @GetMapping
    public List<Policy> getAllPolicies() {
        return policyService.getAllPolicies();
    }

    @GetMapping("/read-only")
    public List<Policy> getAllPoliciesForReadOnly() {
        return policyRepository.findAll();
    }

    @DeleteMapping("/{policyId}")
    public String deletePolicy(@PathVariable Long policyId) {
        policyRepository.deleteById(policyId);
        return "Policy Deleted";
    }

    // View Policies created by SuperUser
    @GetMapping("/super-view")
    public List<PolicyView> getSuperUserPolicies(@RequestHeader("userId") Long superUserId) {
        return policyService.getSuperUserPolicies(superUserId);
    }
}
--------------
// PolicyRequest.java (No changes from your original – it's already good. Comment: Added comments for clarity)
package com.example.policy.dto;

import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;

@Data
public class PolicyRequest {

    private Long userId;

    // Personal Details (Step a)
    private PersonalDetails personalDetails;

    // Income Details (Step b)
    private IncomeDetails incomeDetails;

    // Nominee Details (Step c – list for multiple)
    private List<NomineeDetails> nomineeDetails;

    // Policy Details (Step d)
    private PolicyDetails policyDetails;

    @Data
    public static class PersonalDetails {
        private String name;
        private LocalDate dob;
        private String address;
    }

    @Data
    public static class IncomeDetails {
        private String source;
        private BigDecimal total;
    }

    @Data
    public static class NomineeDetails {
        private String name;
        private String contactNumber;
        private LocalDate dob;
        private String relationship;
        private Integer percentageStake;
    }

    @Data
    public static class PolicyDetails {
        private Long planId;
        private String planName;
        private String planType;
        private BigDecimal coverageLimit;
        private Integer tenureYears;
        private String premiumFrequency;
        private BigDecimal insuredAmount;
        private LocalDate issuanceDate;
    }
}

--------------
// PolicyView.java (No changes from your original – it's already good. Comment: Added comments for clarity)
package com.example.policy.dto;

import lombok.Data;

import java.math.BigDecimal;

@Data
public class PolicyView {

    private Long policyId;
    private String planName;
    private String planType;
    private BigDecimal monthlyPremium;
    private BigDecimal coverageLimit;
}

---------------
// Policy.java (No changes from your original – it's already good. Comment: Added comments for clarity)
package com.example.policy.entity;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonInclude;
import jakarta.persistence.*;

import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDate;

@Data
@Entity
@Table(name = "policies")
public class Policy {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "policy_id")
    private Long id;

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    private String planName;
    private String planType;

    @JsonInclude
    private BigDecimal coverageLimit;

    private Integer tenureYears;
    private String premiumFrequency;
    private BigDecimal insuredAmount;
    private LocalDate issuanceDate;
    private LocalDate maturityDate;
    private BigDecimal premiumAmount;
    private BigDecimal maturityAmount;

    // Personal Details (Step a)
    private String holderName;
    private LocalDate holderDob;
    private String holderAddress;

    // Income Details (Step b)
    private String incomeSource;
    private BigDecimal totalIncome;

    // Metadata
    @JsonIgnore
    private LocalDate approvalTimestamp;

    @JsonIgnore
    private String approverName;

    @JsonIgnore
    private String assignmentDetails;

    // Nominee Details (Step c – merged as JSON string)
    @Lob
    @Column(columnDefinition = "TEXT")
    private String nomineesJson;
}

-------------
// Plan.java (No changes from your original – it's already good. Comment: Added comments for clarity)
package com.example.policy.entity;

import lombok.Data;

import jakarta.persistence.*;

import java.math.BigDecimal;

@Data
@Entity
@Table(name = "plans")
public class Plan {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long userId;

    private String planName;

    private String planType;

    private BigDecimal premiumAmount;

    private BigDecimal coverageLimit;
}

=================

package com.example.policy.repository;

import com.example.policy.entity.Policy;

import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface PolicyRepository extends JpaRepository<Policy, Long> {

    List<Policy> findByUserId(Long userId);  // For "My Policies"
}

===========
package com.example.policy.repository;

import com.example.policy.entity.Plan;

import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface PlanRepository extends JpaRepository<Plan, Long> {
}
-----------------

package com.example.policy.service;

import com.example.policy.dto.PolicyRequest;
import com.example.policy.dto.PolicyView;
import com.example.policy.entity.Plan;
import com.example.policy.entity.Policy;
import com.example.policy.entity.User;
import com.example.policy.repository.PolicyRepository;
import com.example.policy.repository.PlanRepository;
import com.example.policy.repository.UserRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import com.fasterxml.jackson.databind.SerializationFeature;
import lombok.SneakyThrows;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
public class PolicyService {

    @Autowired
    private PolicyRepository policyRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PlanRepository planRepository;

    @SneakyThrows
    public Policy issuePolicy(PolicyRequest req) {

        Optional<User> optUser = userRepository.findById(req.getUserId());
        if (optUser.isEmpty()) {
            throw new RuntimeException("User not found");
        }

        User user = optUser.get();

        Policy policy = new Policy();
        policy.setUser(user);

        // SuperUser creating template with minimal fields
        if (req.isTemplate()) {
            policy.setPlanName(req.getPlanName());
            policy.setPlanType(req.getPlanType());
            policy.setCoverageLimit(req.getCoverageLimit());
            policy.setPremiumAmount(req.getPremiumAmount());  // ← Added for SuperUser creation
            policy.setIsTemplate(true);
        } else {
            // User issuing policy from template
            Optional<Plan> optPlan = planRepository.findById(req.getPlanId());
            if (optPlan.isEmpty()) {
                throw new RuntimeException("Plan not found");
            }

            Plan plan = optPlan.get();

            policy.setPlanName(plan.getPlanName());
            policy.setPlanType(plan.getPlanType());
            policy.setCoverageLimit(plan.getCoverageLimit());
            policy.setPremiumAmount(plan.getPremiumAmount());  // ← Copied from plan

            // Step a: Personal Details
            policy.setHolderName(req.getHolderName());
            policy.setHolderDob(req.getHolderDob());
            policy.setHolderAddress(req.getHolderAddress());

            // Step b: Income Details
            policy.setIncomeSource(req.getIncomeSource());
            policy.setTotalIncome(req.getTotalIncome());

            // Step d: Policy Details
            policy.setTenureYears(req.getTenureYears());
            policy.setPremiumFrequency(req.getPremiumFrequency());
            <column name="insured_amount" value="DECIMAL(15,2)"/>
            policy.setIssuanceDate(req.getIssuanceDate());
            policy.setIsTemplate(false);
        }

        // Auto-calculations
        if (policy.getIssuanceDate() != null && policy.getTenureYears() != null) {
            policy.setMaturityDate(policy.getIssuanceDate().plusYears(policy.getTenureYears()));
        }

        if (policy.getInsuredAmount() != null && policy.getPremiumFrequency() != null) {
            BigDecimal base = policy.getInsuredAmount().multiply(new BigDecimal("0.05"));
            switch (policy.getPremiumFrequency().toLowerCase()) {
                case "monthly" -> policy.setPremiumAmount(base.divide(new BigDecimal("12"), 2, RoundingMode.HALF_UP));
                case "quarterly" -> policy.setPremiumAmount(base.divide(new BigDecimal("4"), 2, RoundingMode.HALF_UP));
                case "half-yearly" -> policy.setPremiumAmount(base.divide(new BigDecimal("2"), 2, RoundingMode.HALF_UP));
                default -> policy.setPremiumAmount(base);
            }
        }

        if (policy.getInsuredAmount() != null && policy.getTenureYears() != null) {
            BigDecimal mat = policy.getInsuredAmount()
                    .multiply(BigDecimal.valueOf(1.5))
                    .multiply(BigDecimal.valueOf(policy.getTenureYears() / 10.0));
            policy.setMaturityAmount(mat);
        }

        // Nominees as JSON
        List<PolicyRequest.NomineeDetails> nominees = req.getNominees();
        if (nominees != null && !nominees.isEmpty()) {
            try {
                policy.setNomineesJson(new ObjectMapper().writeValueAsString(nominees));
            } catch (Exception e) {
                throw new RuntimeException("Failed to process nominees");
            }
        } else {
            policy.setNomineesJson("[]");
        }

        return policyRepository.save(policy);
    }

    public List<Policy> getAllPolicies() {
        return policyRepository.findAll();
    }
}
-------------------------
================

package com.example.policy.dto;

import lombok.Data;

import java.math.BigDecimal;  // ← CHANGE: Added import for BigDecimal
import java.time.LocalDate;  // ← CHANGE: Added import for LocalDate

import java.util.List;

@Data
public class PolicyRequest {

    private Long userId;

    // Personal Details (Step a)
    private PersonalDetails personalDetails;

    // Income Details (Step b)
    private IncomeDetails incomeDetails;

    // Nominee Details (Step c – list for multiple)
    private List<NomineeDetails> nomineeDetails;

    // Policy Details (Step d)
    private PolicyDetails policyDetails;

    @Data
    public static class PersonalDetails {
        private String name;
        private LocalDate dob;
        private String address;
    }

    @Data
    public static class IncomeDetails {
        private String source;
        private BigDecimal total;
    }

    @Data
    public static class NomineeDetails {
        private String name;
        private String contactNumber;
        private LocalDate dob;
        private String relationship;
        private Integer percentageStake;
    }

    @Data
    public static class PolicyDetails {
        private Long planId;
        private String planName;
        private String planType;
        private BigDecimal coverageLimit;
        private Integer tenureYears;
        private String premiumFrequency;
        private BigDecimal insuredAmount;
        private LocalDate issuanceDate;
    }
}

---------
package com.example.policy.service;

import com.example.policy.dto.PolicyRequest;
import com.example.policy.entity.Policy;
import com.example.policy.entity.User;
import com.example.policy.repository.PolicyRepository;
import com.example.policy.repository.UserRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;  // ← CHANGE: Added import for RoundingMode
import java.time.LocalDate;
import java.util.Optional;

@Service
public class PolicyService {

    @Autowired
    private PolicyRepository policyRepository;

    @Autowired
    private UserRepository userRepository;

    private final ObjectMapper mapper = new ObjectMapper();  // ← CHANGE: Initialized mapper for JSON

    public Policy issuePolicy(PolicyRequest req) {
        Optional<User> optUser = userRepository.findById(req.getUserId());
        if (optUser.isEmpty()) {
            throw new RuntimeException("User not found");
        }

        User user = optUser.get();

        Policy policy = new Policy();
        policy.setUser(user);

        // Step a: Personal Details
        policy.setHolderName(req.getPersonalDetails().getName());
        policy.setHolderDob(req.getPersonalDetails().getDob());
        policy.setHolderAddress(req.getPersonalDetails().getAddress());

        // Step b: Income Details
        policy.setIncomeSource(req.getIncomeDetails().getSource());
        policy.setTotalIncome(req.getIncomeDetails().getTotal());

        // Step d: Policy Details
        policy.setPlanName(req.getPolicyDetails().getPlanName());
        policy.setPlanType(req.getPolicyDetails().getPlanType());
        policy.setCoverageLimit(req.getPolicyDetails().getCoverageLimit());
        policy.setTenureYears(req.getPolicyDetails().getTenureYears());
        policy.setPremiumFrequency(req.getPolicyDetails().getPremiumFrequency());
        policy.setInsuredAmount(req.getPolicyDetails().getInsuredAmount());
        policy.setIssuanceDate(req.getPolicyDetails().getIssuanceDate());

        // Auto-calculations
        if (policy.getIssuanceDate() != null && policy.getTenureYears() != null) {
            policy.setMaturityDate(policy.getIssuanceDate().plusYears(policy.getTenureYears()));
        }

        if (policy.getInsuredAmount() != null && policy.getPremiumFrequency() != null) {
            BigDecimal base = policy.getInsuredAmount().multiply(new BigDecimal("0.05"));
            switch (policy.getPremiumFrequency().toLowerCase()) {
                case "monthly" -> policy.setPremiumAmount(base.divide(new BigDecimal("12"), 2, RoundingMode.HALF_UP));
                case "quarterly" -> policy.setPremiumAmount(base.divide(new BigDecimal("4"), 2, RoundingMode.HALF_UP));
                case "half-yearly" -> policy.setPremiumAmount(base.divide(new BigDecimal("2"), 2, RoundingMode.HALF_UP));
                default -> policy.setPremiumAmount(base);
            }
        }

        if (policy.getInsuredAmount() != null && policy.getTenureYears() != null) {
            BigDecimal mat = policy.getInsuredAmount()
                    .multiply(BigDecimal.valueOf(1.5))
                    .multiply(BigDecimal.valueOf(policy.getTenureYears() / 10.0));
            policy.setMaturityAmount(mat);
        }

        // Step c: Nominee Details
        List<PolicyRequest.NomineeDetails> nominees = req.getNomineeDetails();
        if (nominees != null && !nominees.isEmpty()) {
            try {
                policy.setNomineesJson(mapper.writeValueAsString(nominees));
            } catch (JsonProcessingException e) {
                throw new RuntimeException("Failed to process nominees: " + e.getMessage());
            }
        } else {
            policy.setNomineesJson("[]");
        }

        return policyRepository.save(policy);
    }

    public List<Policy> getAllPolicies() {
        return policyRepository.findAll();
    }
}
---

public List<PolicyView> getSuperUserPolicies(Long superUserId) {
    List<Policy> policies = policyRepository.findByUserId(superUserId);  // Fetch only SuperUser's policies
    return policies.stream()
            .map(policy -> {
                PolicyView dto = new PolicyView();
                dto.setPolicyId(policy.getId());
                dto.setPlanName(policy.getPlanName());
                dto.setPlanType(policy.getPlanType());
                dto.setMonthlyPremium(policy.getPremiumAmount());  // Assume monthly; adjust if needed
                dto.setCoverageLimit(policy.getCoverageLimit());
                return dto;
            })
            .collect(Collectors.toList());
}
================================

<!-- Policies Table DDL (for User-issued policies, linked to plans) -->
<changeSet id="002-policies" author="you">
    <createTable tableName="policies">
        <column name="policy_id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="plan_id" type="BIGINT">  // ← CHANGE: Added foreign key to plans.id for user selection
            <constraints nullable="false"/>
        </column>
        <column name="user_id" type="BIGINT">
            <constraints nullable="false"/>
        </column>
        <column name="holder_name" type="VARCHAR(100)"/>
        <column name="holder_dob" type="DATE"/>
        <column name="holder_address" type="VARCHAR(255)"/>
        <column name="income_source" type="VARCHAR(100)"/>
        <column name="total_income" type="DECIMAL(15,2)"/>
        <column name="tenure_years" type="INT"/>
        <column name="premium_frequency" type="VARCHAR(20)"/>
        <column name="insured_amount" type="DECIMAL(15,2)"/>
        <column name="issuance_date" type="DATE"/>
        <column name="maturity_date" type="DATE"/>
        <column name="premium_amount" type="DECIMAL(15,2)"/>
        <column name="maturity_amount" type="DECIMAL(15,2)"/>
        <column name="nominees_json" type="TEXT"/>
        <column name="approval_timestamp" type="TIMESTAMP"/>
        <column name="approver_name" type="VARCHAR(100)"/>
        <column name="assignment_details" type="VARCHAR(255)"/>
    </createTable>




-------
<!-- Policies Table DML (hardcoded user-issued policies with plan_id link) -->
<changeSet id="010-policies-data" author="you">
    <!-- Policy 1: Linked to plan_id 1 -->
    <insert tableName="policies">
        <column name="plan_id" value="1"/>  // ← CHANGE: Links to superuser's plan
        <column name="user_id" value="3"/>
        <column name="holder_name" value="John Doe"/>
        <column name="holder_dob" value="1980-05-15"/>
        <column name="holder_address" value="123 Main St, Bangalore"/>
        <column name="income_source" value="Salary"/>
        <column name="total_income" value="100000"/>
        <column name="tenure_years" value="15"/>
        <column name="premium_frequency" value="yearly"/>
        <column name="insured_amount" value="1000000"/>
        <column name="issuance_date" value="2025-01-15"/>
        <column name="maturity_date" value="2040-01-15"/>
        <column name="premium_amount" value="45000"/>
        <column name="maturity_amount" value="1500000"/>
        <column name="nominees_json" value='[{"name":"Jane Doe","contactNumber":"1234567890","dob":"2000-01-01","relationship":"Child","percentageStake":100}]'/>
        <column name="approval_timestamp" valueComputed="CURRENT_TIMESTAMP"/>
        <column name="approver_name" value="John Approver"/>
        <column name="assignment_details" value="Assigned to Ravi User"/>
    </insert>

    <!-- Policy 2: Linked to plan_id 2 -->
    <insert tableName="policies">
        <column name="plan_id" value="2"/>  // ← CHANGE: Links to superuser's plan
        <column name="user_id" value="2"/>
        <column name="holder_name" value="Jane Smith"/>
        <column name="holder_dob" value="1990-08-20"/>
        <column name="holder_address" value="456 Elm St, Town"/>
        <column name="income_source" value="Business"/>
        <column name="total_income" value="150000"/>
        <column name="tenure_years" value="10"/>
        <column name="premium_frequency" value="monthly"/>
        <column name="insured_amount" value="500000"/>
        <column name="issuance_date" value="2024-06-01"/>
        <column name="maturity_date" value="2034-06-01"/>
        <column name="premium_amount" value="12000"/>
        <column name="maturity_amount" value="800000"/>
        <column name="nominees_json" value='[{"name":"John Smith","contactNumber":"0987654321","dob":"1985-08-20","relationship":"Spouse","percentageStake":100}]'/>
        <column name="approval_timestamp" valueComputed="CURRENT_TIMESTAMP"/>
        <column name="approver_name" value="John Approver"/>
        <column name="assignment_details" value="Assigned to John Approver"/>
    </insert>

    <!-- Policy 3: Linked to plan_id 3 -->
    <insert tableName="policies">
        <column name="plan_id" value="3"/>  // ← CHANGE: Links to superuser's plan
        <column name="user_id" value="3"/>
        <column name="holder_name" value="Alice Johnson"/>
        <column name="holder_dob" value="1985-03-10"/>
        <column name="holder_address" value="789 Oak St, Village"/>
        <column name="income_source" value="Freelance"/>
        <column name="total_income" value="80000"/>
        <column name="tenure_years" value="20"/>
        <column name="premium_frequency" value="quarterly"/>
        <column name="insured_amount" value="750000"/>
        <column name="issuance_date" value="2023-03-10"/>
        <column name="maturity_date" value="2043-03-10"/>
        <column name="premium_amount" value="18000"/>
        <column name="maturity_amount" value="1200000"/>
        <column name="nominees_json" value='[{"name":"Emily Johnson","contactNumber":"5551234567","dob":"2000-03-10","relationship":"Child","percentageStake":50},{"name":"Bob Johnson","contactNumber":"4449876543","dob":"1995-12-05","relationship":"Sibling","percentageStake":50}]'/>
        <column name="approval_timestamp" valueComputed="CURRENT_TIMESTAMP"/>
        <column name="approver_name" value="John Approver"/>
        <column name="assignment_details" value="Assigned to Alice User"/>
    </insert>
</changeSet>

</changeSet>
========================
<!-- Hardcoded 5 plans -->
<changeSet id="011-plans-data" author="you">
    <insert tableName="plans">
        <column name="user_id" value="1"/>
        <column name="plan_name" value="Life Secure Plus"/>
        <column name="plan_type" value="Life Insurance"/>
        <column name="premium_amount" value="20000"/>
        <column name="coverage_limit" value="1500000"/>
    </insert>

    <insert tableName="plans">
        <column name="user_id" value="1"/>
        <column name="plan_name" value="Health Protect"/>
        <column name="plan_type" value="Health Insurance"/>
        <column name="premium_amount" value="15000"/>
        <column name="coverage_limit" value="500000"/>
    </insert>

    <insert tableName="plans">
        <column name="user_id" value="1"/>
        <column name="plan_name" value="Property Guard"/>
        <column name="plan_type" value="Property Insurance"/>
        <column name="premium_amount" value="18000"/>
        <column name="coverage_limit" value="1000000"/>
    </insert>

    <insert tableName="plans">
        <column name="user_id" value="1"/>
        <column name="plan_name" value="Motor Safe"/>
        <column name="plan_type" value="Motor Insurance"/>
        <column name="premium_amount" value="12000"/>
        <column name="coverage_limit" value="750000"/>
    </insert>

    <insert tableName="plans">
        <column name="user_id" value="1"/>
        <column name="plan_name" value="Family Life Cover"/>
        <column name="plan_type" value="Life Insurance"/>
        <column name="premium_amount" value="25000"/>
        <column name="coverage_limit" value="2000000"/>
    </insert>
</changeSet>

-------------
<!-- Add plan_id to policies -->
<changeSet id="012-add-plan-id" author="you">
    <addColumn tableName="policies">
        <column name="plan_id" type="BIGINT"/>
    </addColumn>
</changeSet>

----------

<!-- Hardcoded 3 policies with plan_id -->
<changeSet id="010-policies-data" author="you">
    <insert tableName="policies">
        <column name="plan_id" value="1"/>  // Links to plan 1
        <column name="user_id" value="3"/>
        <column name="holder_name" value="John Doe"/>
        <column name="holder_dob" value="1980-05-15"/>
        <column name="holder_address" value="123 Main St, Bangalore"/>
        <column name="income_source" value="Salary"/>
        <column name="total_income" value="100000"/>
        <column name="tenure_years" value="15"/>
        <column name="premium_frequency" value="yearly"/>
        <column name="insured_amount" value="1000000"/>
        <column name="issuance_date" value="2025-01-15"/>
        <column name="maturity_date" value="2040-01-15"/>
        <column name="premium_amount" value="45000"/>
        <column name="maturity_amount" value="1500000"/>
        <column name="nominees_json" value='[{"name":"Jane Doe","contactNumber":"1234567890","dob":"2000-01-01","relationship":"Child","percentageStake":100}]'/>
    </insert>

    <insert tableName="policies">
        <column name="plan_id" value="2"/>  // Links to plan 2
        <column name="user_id" value="2"/>
        <column name="holder_name" value="Jane Smith"/>
        <column name="holder_dob" value="1990-08-20"/>
        <column name="holder_address" value="456 Elm St, Town"/>
        <column name="income_source" value="Business"/>
        <column name="total_income" value="150000"/>
        <column name="tenure_years" value="10"/>
        <column name="premium_frequency" value="monthly"/>
        <column name="insured_amount" value="500000"/>
        <column name="issuance_date" value="2024-06-01"/>
        <column name="maturity_date" value="2034-06-01"/>
        <column name="premium_amount" value="12000"/>
        <column name="maturity_amount" value="800000"/>
        <column name="nominees_json" value='[{"name":"John Smith","contactNumber":"0987654321","dob":"1985-08-20","relationship":"Spouse","percentageStake":100}]'/>
    </insert>

    <insert tableName="policies">
        <column name="plan_id" value="3"/>  // Links to plan 3
        <column name="user_id" value="3"/>
        <column name="holder_name" value="Alice Johnson"/>
        <column name="holder_dob" value="1985-03-10"/>
        <column name="holder_address" value="789 Oak St, Village"/>
        <column name="income_source" value="Freelance"/>
        <column name="total_income" value="80000"/>
        <column name="tenure_years" value="20"/>
        <column name="premium_frequency" value="quarterly"/>
        <column name="insured_amount" value="750000"/>
        <column name="issuance_date" value="2023-03-10"/>
        <column name="maturity_date" value="2043-03-10"/>
        <column name="premium_amount" value="18000"/>
        <column name="maturity_amount" value="1200000"/>
        <column name="nominees_json" value='[{"name":"Emily Johnson","contactNumber":"5551234567","dob":"2000-03-10","relationship":"Child","percentageStake":50},{"name":"Bob Johnson","contactNumber":"4449876543","dob":"1995-12-05","relationship":"Sibling","percentageStake":50}]'/>
    </insert>
</changeSet>

