<!-- Hardcoded policies (SuperUser templates + user-issued) -->
<changeSet id="010-wizard-data" author="you">
    <!-- SuperUser created plans (is_template = true) -->
    <insert tableName="policies">
        <column name="user_id" value="1"/>
        <column name="plan_name" value="Family Life Cover"/>
        <column name="plan_type" value="Life Insurance"/>
        <column name="coverage_limit" value="1500000"/>
        <column name="tenure_years" value="30"/>
        <column name="premium_frequency" value="quarterly"/>
        <column name="insured_amount" value="1000000"/>
        <column name="is_template" valueBoolean="true"/>
    </insert>

    <!-- User-issued policy (is_template = false) -->
    <insert tableName="policies">
        <column name="user_id" value="3"/>
        <column name="holder_name" value="John Doe"/>
        <column name="holder_dob" value="1980-05-15"/>
        <column name="holder_address" value="123 Main St, Bangalore"/>
        <column name="income_source" value="Salary"/>
        <column name="total_income" value="100000"/>
        <column name="plan_name" value="Family Life Cover"/>
        <column name="plan_type" value="Life Insurance"/>
        <column name="coverage_limit" value="1500000"/>
        <column name="tenure_years" value="30"/>
        <column name="premium_frequency" value="quarterly"/>
        <column name="insured_amount" value="1000000"/>
        <column name="issuance_date" value="2026-02-10"/>
        <column name="maturity_date" value="2056-02-10"/>
        <column name="premium_amount" value="12500"/>
        <column name="maturity_amount" value="1500000"/>
        <column name="nominees_json" value='[{"name":"Jane Doe","contactNumber":"1234567890","dob":"2000-01-01","relationship":"Child","percentageStake":100}]'/>
        <column name="is_template" valueBoolean="false"/>
    </insert>
</changeSet>
-------

package com.example.policy.dto;

import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;

@Data
public class PolicyRequest {
    private Long userId;  // User who is issuing the policy

    // Personal Details (Step a)
    private String holderName;
    private LocalDate holderDob;
    private String holderAddress;

    // Income Details (Step b)
    private String incomeSource;
    private BigDecimal totalIncome;

    // Nominee Details (Step c – list for multiple)
    private List<NomineeDetails> nominees;

    // Policy Details (Step d – selected from SuperUser plan)
    private Long planId;  // User selects this ID (same as policy_id)

    @Data
    public static class NomineeDetails {
        private String name;
        private String contactNumber;
        private LocalDate dob;
        private String relationship;
        private Integer percentageStake;
    }
}

-------------
package com.example.policy.service;

import com.example.policy.dto.PolicyRequest;
import com.example.policy.entity.Policy;
import com.example.policy.entity.User;
import com.example.policy.repository.PolicyRepository;
import com.example.policy.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Service
public class PolicyService {

    @Autowired
    private PolicyRepository policyRepository;

    @Autowired
    private UserRepository userRepository;

    public Policy issuePolicy(PolicyRequest req) {
        Optional<User> optUser = userRepository.findById(req.getUserId());
        if (optUser.isEmpty()) {
            throw new RuntimeException("User not found");
        }

        User user = optUser.get();

        Policy policy = new Policy();
        policy.setId(req.getPlanId());  // ← CHANGE: Shared ID (plan_id = policy_id)
        policy.setUser(user);
        policy.setPlanName(req.getPlanName());
        policy.setPlanType(req.getPlanType());
        policy.setTenureYears(req.getTenureYears());
        policy.setPremiumFrequency(req.getPremiumFrequency());
        policy.setInsuredAmount(req.getInsuredAmount());
        policy.setIssuanceDate(req.getIssuanceDate());
        policy.setHolderName(req.getHolderName());
        policy.setHolderDob(req.getHolderDob());
        policy.setHolderAddress(req.getHolderAddress());
        policy.setIncomeSource(req.getIncomeSource());
        policy.setTotalIncome(req.getTotalIncome());

        // Auto-calculations
        if (policy.getIssuanceDate() != null && policy.getTenureYears() != null) {
            policy.setMaturityDate(policy.getIssuanceDate().plusYears(policy.getTenureYears()));
        }

        if (policy.getInsuredAmount() != null && policy.getPremiumFrequency() != null) {
            BigDecimal base = policy.getInsuredAmount().multiply(new BigDecimal("0.05"));
            switch (policy.getPremiumFrequency().toLowerCase()) {
                case "monthly" -> policy.setPremiumAmount(base.divide(new BigDecimal("12"), 2, RoundingMode.HALF_UP));
                case "quarterly" -> policy.setPremiumAmount(base.divide(new BigDecimal("4"), 2, RoundingMode.HALF_UP));
                case "half-yearly" -> policy.setPremiumAmount(base.divide(new BigDecimal("2"), 2, RoundingMode.HALF_UP));
                default -> policy.setPremiumAmount(base);
            }
        }

        if (policy.getInsuredAmount() != null && policy.getTenureYears() != null) {
            BigDecimal mat = policy.getInsuredAmount()
                    .multiply(BigDecimal.valueOf(1.5))
                    .multiply(BigDecimal.valueOf(policy.getTenureYears() / 10.0));
            policy.setMaturityAmount(mat);
        }

        // Nominees as JSON
        List<PolicyRequest.NomineeDetails> nominees = req.getNominees();
        if (nominees != null && !nominees.isEmpty()) {
            try {
                policy.setNomineesJson(new ObjectMapper().writeValueAsString(nominees));
            } catch (Exception e) {
                throw new RuntimeException("Failed to process nominees");
            }
        } else {
            policy.setNomineesJson("[]");
        }

        policy.setIsTemplate(false);  // User-issued policy

        return policyRepository.save(policy);
    }

    public List<Policy> getAllPolicies() {
        return policyRepository.findAll();
    }
}
----------

package com.example.policy.controller;

import com.example.policy.entity.Policy;
import com.example.policy.service.PolicyService;
import com.example.policy.dto.PolicyRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import com.example.policy.repository.PolicyRepository;

import java.util.List;

@RestController
@RequestMapping("/api/policies")
public class PolicyController {

    @Autowired
    private PolicyService policyService;

    @Autowired
    private PolicyRepository policyRepository;

    @PostMapping("/create")  // Single endpoint for the entire wizard
    public Policy createPolicy(@RequestBody PolicyRequest req) {
        return policyService.issuePolicy(req);
    }

    @GetMapping
    public List<Policy> getAllPolicies() {
        return policyService.getAllPolicies();
    }

    @GetMapping("/read-only")
    public List<Policy> getAllPoliciesForReadOnly() {
        return policyRepository.findAll();
    }

    @DeleteMapping("/{policyId}")
    public String deletePolicy(@PathVariable Long policyId) {
        policyRepository.deleteById(policyId);
        return "Policy Deleted";
    }
}

----------
policy.setUserId(req.getUserId());
        policy.setPlanName(req.getPlanName());
        policy.setPlanType(req.getPlanType());
        policy.setCoverageLimit(req.getCoverageLimit());
        policy.setIsTemplate(true);

